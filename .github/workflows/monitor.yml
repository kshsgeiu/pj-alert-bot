name: PJ Alert Bot

on:
  schedule:
    # ë§¤ 15ë¶„ë§ˆë‹¤ ì‹¤í–‰ (GitHub Actions ë¬´ë£Œ í‹°ì–´ì—ì„œ ì•ˆì •ì )
    - cron: '*/15 * * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
  
  # í‘¸ì‹œí•  ë•Œë„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  push:
    branches: [ main, master ]

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    # GitHub Actionsì— ì“°ê¸° ê¶Œí•œ ë¶€ì—¬
    permissions:
      contents: write
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        # ìºì‹œ íŒŒì¼ ì»¤ë°‹ì„ ìœ„í•´ í† í° ì‚¬ìš©
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 cloudscraper
    
    - name: ìƒí’ˆ ëª¨ë‹ˆí„°ë§ ì‹¤í–‰
      id: monitor
      run: python pj_monitor.py
      env:
        TG_TOKEN: ${{ secrets.TG_TOKEN }}
        TG_CHAT: ${{ secrets.TG_CHAT }}
    
    - name: í…”ë ˆê·¸ë¨ ìƒíƒœ ì•Œë¦¼ (ë§¤ë²ˆ ì‹¤í–‰)
      run: |
        # í˜„ì¬ ì‹œê°„
        CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        
        # ë³€í™”ê°€ ìˆëŠ” ê²½ìš°
        if [ -f "alert.txt" ]; then
          ALERT_MESSAGE=$(cat alert.txt)
          echo "ğŸ”¥ ë³€í™” ê°ì§€ ì•Œë¦¼:"
          echo "$ALERT_MESSAGE"
          
          curl -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
            -F chat_id="${{ secrets.TG_CHAT }}" \
            -F text="$ALERT_MESSAGE" \
            -F parse_mode="Markdown" \
            -F disable_web_page_preview=true
        else
          # ë³€í™”ê°€ ì—†ì–´ë„ ìƒíƒœ ë¦¬í¬íŠ¸ ë°œì†¡
          STATUS_MESSAGE="âœ… PJ Bot ìƒíƒœ ë¦¬í¬íŠ¸
          
ğŸ“Š ëª¨ë‹ˆí„°ë§ ì™„ë£Œ
â€¢ ì‹œê°„: $CURRENT_TIME  
â€¢ ìƒíƒœ: ì •ìƒ ë™ì‘ ì¤‘
â€¢ ë³€í™”: ì—†ìŒ (ëª¨ë“  ìƒí’ˆ í’ˆì ˆ ìƒíƒœ ìœ ì§€)

ğŸ” í˜„ì¬ ê°ì‹œ ì¤‘
â€¢ Pointless Journey ì „ì²´ ìƒí’ˆ
â€¢ ì‹ ìƒí’ˆ ì¶œì‹œ ê°ì§€  
â€¢ ì¬ì…ê³  ì•Œë¦¼ ëŒ€ê¸°

â° ë‹¤ìŒ ì²´í¬: 15ë¶„ í›„"

          echo "ğŸ“Š ìƒíƒœ ë¦¬í¬íŠ¸ ë°œì†¡:"
          echo "$STATUS_MESSAGE"
          
          curl -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
            -F chat_id="${{ secrets.TG_CHAT }}" \
            -F text="$STATUS_MESSAGE" \
            -F parse_mode="Markdown" \
            -F disable_web_page_preview=true
        fi
    
    - name: Git ì„¤ì •
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: ìºì‹œ íŒŒì¼ ì»¤ë°‹
      run: |
        if [ -f "cache.json" ]; then
          git add cache.json
          if git diff --staged --quiet; then
            echo "ìºì‹œ ë³€í™” ì—†ìŒ"
          else
            git commit -m "ìºì‹œ ì—…ë°ì´íŠ¸: $(date '+%Y-%m-%d %H:%M:%S')"
            git push
          fi
        fi
      continue-on-error: true
    
    - name: ì‹¤í–‰ ê²°ê³¼ ë¡œê·¸
      run: |
        echo "=== ëª¨ë‹ˆí„°ë§ ì™„ë£Œ ==="
        echo "ì‹œê°„: $(date)"
        echo "ìƒíƒœ: ${{ steps.monitor.outputs.has_changes }}"
        if [ -f "cache.json" ]; then
          echo "ìºì‹œ í¬ê¸°: $(wc -l < cache.json) ì¤„"
        fi