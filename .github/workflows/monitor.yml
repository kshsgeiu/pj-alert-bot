name: PJ Alert Bot

on:
  schedule:
    - cron: '*/15 * * * *'  # ë§¤ 15ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  push:
    branches: [ main, master ]

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 cloudscraper
    
    - name: ìƒí’ˆ ëª¨ë‹ˆí„°ë§ ì‹¤í–‰
      id: monitor
      run: python pj_monitor.py
      env:
        TG_TOKEN: ${{ secrets.TG_TOKEN }}
        TG_CHAT: ${{ secrets.TG_CHAT }}
    
    - name: í…”ë ˆê·¸ë¨ ì•Œë¦¼ ë°œì†¡
      run: |
        CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        
        if [ -f "alert.txt" ]; then
          echo "ğŸ”¥ ë³€í™” ê°ì§€ - ìƒì„¸ ì•Œë¦¼ ë°œì†¡"
          ALERT_MESSAGE=$(cat alert.txt)
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
            -F chat_id="${{ secrets.TG_CHAT }}" \
            -F text="$ALERT_MESSAGE" \
            -F parse_mode="Markdown" \
            -F disable_web_page_preview=true
        else
          echo "ğŸ“Š ìƒíƒœ ë¦¬í¬íŠ¸ ë°œì†¡"
          
          # ìƒíƒœ ë©”ì‹œì§€ë¥¼ íŒŒì¼ë¡œ ì‘ì„±
          cat > status_message.txt << 'EOF'
        âœ… PJ Bot ìƒíƒœ ë¦¬í¬íŠ¸
        
        ğŸ“Š ëª¨ë‹ˆí„°ë§ ì™„ë£Œ
        â€¢ ìƒíƒœ: ì •ìƒ ë™ì‘ ì¤‘
        â€¢ ë³€í™”: ì—†ìŒ (ëª¨ë“  ìƒí’ˆ í’ˆì ˆ ìƒíƒœ ìœ ì§€)
        
        ğŸ” í˜„ì¬ ê°ì‹œ ì¤‘
        â€¢ Pointless Journey ì „ì²´ ìƒí’ˆ
        â€¢ ì‹ ìƒí’ˆ ì¶œì‹œ ê°ì§€
        â€¢ ì¬ì…ê³  ì•Œë¦¼ ëŒ€ê¸°
        
        â° ë‹¤ìŒ ì²´í¬: 15ë¶„ í›„
        EOF
          
          # ì‹œê°„ ì •ë³´ ì¶”ê°€
          sed -i "s/â€¢ ìƒíƒœ: ì •ìƒ ë™ì‘ ì¤‘/â€¢ ì‹œê°„: ${CURRENT_TIME}\\nâ€¢ ìƒíƒœ: ì •ìƒ ë™ì‘ ì¤‘/" status_message.txt
          
          # í…”ë ˆê·¸ë¨ ë°œì†¡
          STATUS_MESSAGE=$(cat status_message.txt)
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
            -F chat_id="${{ secrets.TG_CHAT }}" \
            -F text="$STATUS_MESSAGE" \
            -F disable_web_page_preview=true
        fi
    
    - name: Git ì„¤ì •
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: ìºì‹œ íŒŒì¼ ì»¤ë°‹
      run: |
        if [ -f "cache.json" ]; then
          git add cache.json
          if git diff --staged --quiet; then
            echo "ìºì‹œ ë³€í™” ì—†ìŒ"
          else
            git commit -m "ìºì‹œ ì—…ë°ì´íŠ¸: $(date '+%Y-%m-%d %H:%M:%S')"
            git push
          fi
        fi
      continue-on-error: true
    
    - name: ì‹¤í–‰ ê²°ê³¼ ë¡œê·¸
      run: |
        echo "=== ëª¨ë‹ˆí„°ë§ ì™„ë£Œ ==="
        echo "ì‹œê°„: $(date)"
        if [ -f "cache.json" ]; then
          echo "ìºì‹œ í¬ê¸°: $(wc -l < cache.json) ì¤„"
        fi